<style>

    table.dataTable.select tbody tr,
    table.dataTable thead th:first-child {
        cursor: pointer; /*puntero*/
    }

    .contenedorCheck {
        display: block;
        position: relative;
        padding-left: 35px;
        margin-bottom: 12px;
        cursor: pointer;
        font-size: 22px;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

        /* Oculta la casilla de verificación predeterminada del navegador */
        .contenedorCheck input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

    /* propiedades del span */
    .checkmark {
        position: absolute;
        top: 0;
        left: 0;
        height: 20px;
        width: 20px;
        background-color: #eee;
    }

    /* evento mouse-over, add a grey background color */
    .contenedorCheck:hover input ~ .checkmark {
        background-color: #ccc;
    }

    /* cuando el checkbox está checked, add el background naranjo */
    .contenedorCheck input:checked ~ .checkmark {
        background-color: #ff6a00;
    }

    /* Crea el ticket de verificación (oculto cuando no está marcado) */
    .checkmark:after {
        content: "";
        position: absolute;
        display: none;
    }

    /* Muestra el ticket de verificación cuando esté marcado*/
    .contenedorCheck input:checked ~ .checkmark:after {
        display: block;
    }

    /* estilos del ticket */
    .contenedorCheck .checkmark:after {
        left: 7px;
        top: 5px;
        width: 5px;
        height: 10px;
        border: solid #000000;
        border-width: 0 3px 3px 0;
        -webkit-transform: rotate(45deg);
        -ms-transform: rotate(45deg);
        transform: rotate(45deg);
    }
</style>
<div class="box box-warning">
    <div class="box-header with-border">
        <h3 class="box-title"><i class="fa fa-file-excel-o"></i> Crear XLS para bancos</h3>
    </div>
</div>

<div class="box-default">
    <div class="box">
        <div class="panel panel-heading">
            <div class="row">
                <div class="col-md-3">
                    <select class="form-control" id="selectClientes" name="selectClientes"></select>
                </div>

                <div class="col-md-3 pull-right">
                    <select class="form-control" id="tipoReport" name="tipoReport">
                        <option value="0">Seleccione un tipo de reporte.</option>
                        <option value="1">Reporte 1</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="box-body">
            <div class="header">
                <div class="pull-right">
                    <label class='contenedorCheck selector' id="selector">
                        <input type='checkbox' value='1' name="select_all">
                        <span class='checkmark'></span>
                    </label>
                </div>
                <div class="pull-right" style="padding-right:10px;">
                    <b><i>Seleccionar todo </i></b>
                </div>
            </div>

            <table class="table table-striped table-bordered table-sm" cellspacing="0" style="width:100%" id="tblXls">
                <thead>
                    <tr>
                        <th>Cuenta de Origen</th>
                        <th>Moneda</th>
                        <th>Cuenta Destino</th>
                        <th>Banco</th>
                        <th>Fecha</th>
                        <th>Monto</th>
                        <th>Glosa</th>
                        <th>Correo</th>
                        <th>N° Doc</th>
                        <th>Banco</th>
                        <th>Cuenta</th>
                        <th>Rut</th>
                        <th>Nombre Proveedor</th>
                        <th style="background-color:#e5e5e5">XLS</th>
                        <th style="background-color:#e5e5e5">XLS ant</th>
                        <th>Moneda</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>


<script>

    $(function () {

        callclie();


        $('#tipoReport').change(function () {
            $('label.selector > input[name="select_all"]').prop('checked', false);
            table.ajax.reload();
        });

        $('#selectClientes').change(function () {
            $('label.selector > input[name="select_all"]').prop('checked',false);
            table.ajax.reload();
        });

        var columnastbl = [
           
            { "data": "cuenta" },
            {
                "data": "moneda", "render": function (data) {
                    if (data == 5) {
                        return "CLP";
                    } else {
                        return "";
                    }

                }
            },
            { "data": "cta" },
            { "data": "codBanco"},
            {
                "data": "fecha", "render": function (data) {
                    return moment(data).format('DD-MM-YYYY');
                }
            },
            { "data": "monto" },
            { "data": "glosa" },
            { "data": "correo" },
            { "data": "numDoc" },
            { "data": "nomBanco" },
            { "data": "cuenta" },
            { "data": "codAux" },
            { "data": "nomAux" },
            {
                "data": "empty", "render": function (data) {
                    return "<label class='contenedorCheck'>" +
                        "<input type='checkbox'>" +
                        "<span class='checkmark' style='background-color:#ffe58c!important'></span>" +
                        "</label>";

                }
            },
            {
                "data": "xls", "render": function (data) {
                    return (data == "S" ? "<label class='contenedorCheck'>" +
                        "<input type='checkbox' checked disabled>" +
                        "<span class='checkmark' style='background-color:#ffe58c!important'></span>" +
                        "</label>" : "<label class='contenedorCheck'>" +
                        "<input type='checkbox' disabled>" +
                        "<span class='checkmark' style='background-color:#ffe58c!important'></span>" +
                        "</label>");

                }
            },
            {
                "data": "moneda", "render": function (data) {
                    if (data == 5) {
                        return "CLP";
                    } else {
                        return "";
                    }

                }
            },
        ]


        function retornaID(d) {
            return $.extend({}, d, {
                "id": $('#selectClientes').val(),
                "idrep": $('#tipoReport').val()
            });
        }

        function callclie() {
            $.ajax({
                url: '@Url.Action("getClientes", "XlsBancos")',
                type: 'POST',
                success: function (rsp) {
                    debugger;
                    $('#selectClientes').append("<option label='--Seleccione--' value='0'></option>");
                    $.map(rsp.data, function (i, item) {
                        $('#selectClientes').append("<option value=" + i.id_cliente + ">" + i.nom_cliente + " :   " + i.conteo + "</option>");
                    });
                }
            });
        }



        //Exporto solo los que tengan la clase selected
        var fnExportar = {
            exportOptions: {
                  rows: '.selected',
                  columns: [0, 1, 2, 15 , 3, 11, 12 , 5, 6, 7]
            },
            customize: function (win) {
                console.log(win);

                //Aquí lanzo la función al descargar el excel.
            }
        };



        function getXls(grilla, url, parametros, columnas) {

            tabla = $('#' + grilla).DataTable({
                "ajax": {
                    "url": url,
                    "type": "POST",
                    "data": parametros
                    
                },
                "bPaginate": false,
                "bFilter": true,
                "bInfo": false,
                "scrollY": "600px",
                "scrollCollapse": true,
                pageLength: 1000,
                dom: 'Bfrtip',
                buttons: [
                    $.extend(true, {}, fnExportar, {
                        extend: "excelHtml5",
                        title: null,
                        text: 'Generar Excel'
                     
                    })

                ],
                columnDefs: [
                    { visible: false, targets: [0,1,2,3,6,7,15] }
                ],
                columns: columnas,
                order: [1, 'asc']
            });
            return tabla;
        }



        var table = getXls('tblXls', '@Url.Action("getData", "XlsBancos")', retornaID, columnastbl);


        $("#tblXls tbody").on("click", 'input[type="checkbox"]', function (e) {

            var $row = $(this).closest('tr');
            $($row).toggleClass('selected');
            table.row($row, { selected: true }).data()
        
        });


        $('label.selector > input[name="select_all"]').click(function (e) {
            if (this.checked) {
                $('#tblXls tbody input[type="checkbox"]:not(:checked)').trigger('click');
            } else {
                $('#tblXls tbody input[type="checkbox"]:checked').trigger('click');
            }
            e.stopPropagation();
        });

    });
</script>